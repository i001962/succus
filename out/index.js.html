<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { ethers } from "ethers";
import Gun from "gun";
import "gun/sea";
const gun = Gun({ localStorage: false, radisk: false });
const SEA = Gun.SEA;
/**
 * This function is used by succus to connect to the user wallet.
 * @async
 * @function
 * @returns {Promise&lt;WalletInfo>} An object which contains: the address of the account, the reference to the wallet and the reference to the provider.
 * @example
 * const {address, wallet, provider, gunKeypair} = connectWallet();
 * console.log(address) // 0x...
 */
const connectWallet = async () => {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const accountAddress = await signer.getAddress();
    const keypair = await SEA.pair();
    return { address: accountAddress, wallet: signer, provider: provider, gunKeypair: keypair };
};
async function encryptMessage(msg, encryptingKeyPair) {
    const encrypted = await SEA.encrypt(msg, encryptingKeyPair);
    return encrypted;
}
/**
 * Hash a string in base64.
 * @async
 * @function
 * @param {string} string The string to be converted
 * @returns {string} The string in base64 format
 * @example
 * console.log(HashNamespace("Hello World")) // 'SGVsbG8gV29ybGQ='
 */
function HashNamespace(string) {
    return window.btoa(string);
}
/**
 * This function is used to send a message to someone or a group of persons.
 * @async
 * @function
 * @param {string} payload The message to send.
 * @param {string[]} to The array containing the addresses of the persons you want to send the message to.
 * @param {ethers.providers.Web3Provider} provider A reference to the wallet provider.
 * @param {ISEAPair} gunKeypair The keypair used to decrypt messages.
 * @returns {Promise&lt;SendMessageConfirmationReturn>}  If the message was sent it returns an object containing: the date when the message was sent, the encrypted message, the reference to the chat for gun.
 * @example
 * await sendmessage("Hello stranger!", [&lt;ETH addresses here>], WalletProvider, &lt;KeyPairForEncryption => generate it with SEA.pair()>)
 */
const sendmessage = async (payload, to, provider, gunKeypair) => {
    const sender_address = await provider.getSigner().getAddress();
    to.push(sender_address);
    try {
        const encrypted_data = await encryptMessage(payload, gunKeypair);
        const chat = gun.get(HashNamespace(await to.sort().join()));
        const ensDomain = await provider.lookupAddress(sender_address);
        await chat.set({ date: Date.now(), encryptedMSG: encrypted_data, from: sender_address, ensFrom: ensDomain });
        return { sent: true, encrypted: encrypted_data, chat: chat };
    }
    catch (e) {
        console.log(e);
        return { sent: false, why: e };
    }
};
/**
 * This function retrieves the message for a certain conversation.
 * @async
 * @function
 * @param from Where to get the message from...
 * @param provider A reference to the wallet provider.
 * @returns {Promise&lt;Array&lt;Message>>}  An array containing the messsages.
 * @example
 * const messages = await receiveMessage(from:[eth Addresses], &lt;WalletProvider>, KeyPairToDecryptMSG)
 * console.table(messages);
 */
const receiveMessage = async (from, provider, gunKeypair) => {
    const sender_address = await provider.getSigner().getAddress();
    await from.push(sender_address);
    const chat = gun.get(HashNamespace(from.sort().join()));
    let messages = [];
    await chat?.map().on(async (data) => {
        const { date, from, ensFrom } = data;
        const decrypted = await SEA.decrypt(data.encryptedMSG, gunKeypair);
        await messages.push({
            sentAt: date,
            from: from,
            name: ensFrom,
            encrypted: data.encryptedMSG,
            content: decrypted
        });
    });
    return await messages;
};
export { sendmessage, receiveMessage, connectWallet, HashNamespace };
//# sourceMappingURL=index.js.map</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#connectWallet">connectWallet</a></li><li><a href="global.html#HashNamespace">HashNamespace</a></li><li><a href="global.html#receiveMessage">receiveMessage</a></li><li><a href="global.html#sendmessage">sendmessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Wed Sep 07 2022 19:54:05 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
